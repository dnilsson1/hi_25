<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kuka AMR Mission Control</title>

    <!-- PWA Manifest for installability -->
    <meta name="theme-color" content="#e0001a"/>
    <link rel="manifest" href="manifest.json" />
    <!-- Apple-specific icon link -->
    <link rel="apple-touch-icon" href="icon-512.png">

    <!-- Tailwind CSS is loaded from a CDN. The service worker will cache this file for offline use. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'legrand-red': '#e0001a',
              'legrand-dark': '#19171a',
            }
          }
        }
      }
    </script>
    <!-- Babel is used to transpile JSX in the browser. The service worker will cache this. -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Import Map for React dependencies. The service worker will cache these. -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.1.1",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.1.1/client",
        "react/": "https://aistudiocdn.com/react@^19.1.1/"
      }
    }
    </script>
</head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <!-- The React application code -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- from constants.ts ---
      const PROFILE_1_MISSIONS = [
        {
          label: "Dispatch from EL",
          templateCode: 'el',
        },
        {
          label: "Dispatch & recieve new pallet",
          templateCode: 'elNew',
        }
      ];

      const PROFILE_2_MISSIONS = [
          {
              label: "Dispatch from Packing Line",
              templateCode: 'packing',
          },
          {
              label: "Dispatch & recieve new pallet",
              templateCode: 'packingNew',
          }
      ];

      // --- from components/icons/LoadingSpinnerIcon.tsx ---
      const LoadingSpinnerIcon = ({ className = 'w-5 h-5' }) => (
        <svg
          className={`animate-spin ${className}`}
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          ></circle>
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      );

      // --- from components/icons/CheckCircleIcon.tsx ---
      const CheckCircleIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
      );

      // --- from components/icons/XCircleIcon.tsx ---
      const XCircleIcon = ({ className = 'w-6 h-6' }) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
      );
      
      // --- from components/icons/GearIcon.tsx ---
      const GearIcon = ({ className = 'w-6 h-6' }) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.213-1.28z" />
          <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      );
      
      // --- from components/LegrandLogo.tsx ---
      const LegrandLogo = ({ className }) => (
          <svg
              className={className}
              viewBox="0 0 250 62"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-label="Legrand Logo"
          >
          <path
            d="M 12.45,0 L 12.45,15.13 L 15.14,15.13 L 15.14,0 L 12.45,0 z M 16.65,3.59 L 16.65,15.09 L 28.77,15.09 L 28.77,45.18 L 39.8,45.18 L 39.8,3.59 L 16.65,3.59 z M 0,3.64 L 0,45.23 L 23.11,45.23 L 23.11,33.73 L 10.99,33.73 L 10.99,3.64 L 0,3.64 z M 24.62,33.68 L 24.62,48.86 L 27.3,48.86 L 27.3,33.68 L 24.62,33.68 z"
            style={{ fill: "#19171a", fillOpacity: 1, fillRule: "nonzero", stroke: "none" }}
          />
          <path
            d="M 54.19,2.41 L 54.19,47.31 L 63.94,47.31 L 63.94,2.41 L 54.19,2.41 z M 226.08,2.41 L 226.08,17.31 C 223.98,15.78 220.57,15.53 220.57,15.53 C 210.07,15.26 205.59,24.14 205.62,31.09 C 205.54,40.2 211.55,47.64 220.53,46.93 C 222.62,46.71 224.34,45.89 226.08,44.52 L 226.08,47.31 L 236.27,47.31 L 236.27,2.41 L 226.08,2.41 z M 81.49,13.26 C 73.5,13.26 65.65,19.83 65.65,30.18 C 65.66,41.83 72.95,48.58 82.58,48.29 C 89.93,48.05 95.02,43.4 96.87,36.88 L 86.82,36.88 C 86.31,37.92 84.9,39.14 81.96,39.14 C 78.2,39.14 76.21,36.35 76.21,33.58 L 97.43,33.58 C 98.64,21.49 90.85,13.26 81.49,13.26 z M 152.8,13.91 C 147.67,13.91 143.46,17.84 143.46,17.84 L 143.46,14.49 L 133,14.49 L 133,47.31 L 143.46,47.31 L 143.46,30.56 C 143.53,22.38 152.8,21.79 152.8,21.79 L 152.8,13.91 z M 155.2,13.91 L 155.2,21.56 C 155.2,21.56 156.1,21.34 159.88,21.46 C 164.68,21.64 164.12,25.56 164.12,25.56 C 164.12,25.56 161.78,24.13 158.41,24.1 C 154.73,24.01 147.34,26.26 147.34,36.04 C 147.32,44.65 154.23,47.16 158.32,47.16 C 162.26,47.16 164.54,45.23 164.54,45.23 L 164.54,47.31 L 174.06,47.31 C 174.06,47.31 174.06,29.64 174.06,24.94 C 174.06,20.6 173.26,19.42 171.28,17.22 C 168.51,14.17 161.94,13.91 161.94,13.91 L 155.2,13.91 z M 120.68,14.44 L 120.68,17.88 C 113.94,11.06 98.2,15.99 98.76,31.37 C 99.24,45.77 114.47,50.1 120.68,44.52 L 120.68,48.33 C 120.65,52.7 115.31,52.55 115.31,52.55 C 110.65,52.33 109.65,49.38 109.65,49.38 L 97.9,49.38 C 100.36,65.78 129.14,66.41 130.49,50.7 L 130.49,14.44 L 120.68,14.44 z M 176.33,14.44 L 176.33,47.31 L 186.38,47.31 L 186.38,27.92 C 186.38,23.24 193.83,22.92 193.83,27.92 L 193.83,47.31 L 203.73,47.31 L 203.73,22.74 C 203.73,17.78 197.27,10.49 186.38,17.55 L 186.38,14.44 L 176.33,14.44 z M 81.49,21.88 C 84.3,21.88 86.61,23.98 86.91,26.69 L 76.08,26.69 C 76.39,23.98 78.69,21.88 81.49,21.88 z M 114.6,24.58 C 118.1,24.58 120.97,27.42 120.97,30.93 C 120.97,34.45 118.1,37.26 114.6,37.26 C 111.09,37.26 108.28,34.45 108.28,30.93 C 108.28,27.42 111.09,24.58 114.6,24.58 z M 220.42,24.85 C 223.91,24.85 226.74,27.71 226.74,31.22 C 226.74,34.71 223.91,37.54 220.42,37.54 C 216.92,37.54 214.1,34.71 214.1,31.22 C 214.11,27.71 216.92,24.85 220.42,24.85 z M 160.43,30.98 C 162.76,30.98 164.63,32.91 164.63,35.24 C 164.63,37.58 162.76,39.43 160.43,39.43 C 158.1,39.43 156.19,37.58 156.19,35.24 C 156.19,32.91 158.1,30.98 160.43,30.98 z"
            style={{ fill: "#e0001a", fillOpacity: 1, fillRule: "nonzero", stroke: "none" }}
          />
          <path
            d="M 244.28,2.46 C 241.17,2.46 238.58,5.04 238.58,8.16 C 238.58,11.32 241.17,13.87 244.28,13.87 C 247.45,13.87 250,11.32 250,8.16 C 250,5.04 247.43,2.46 244.28,2.46 z M 244.28,3.26 C 247,3.26 249.2,5.49 249.2,8.16 C 249.2,10.86 246.98,13.02 244.28,13.02 C 241.59,13.02 239.39,10.86 239.39,8.16 C 239.38,5.49 241.58,3.26 244.28,3.26 z M 242.02,5.1 L 242.02,11.09 L 242.83,11.09 L 242.83,8.49 L 244.76,8.49 C 245.71,8.49 245.85,9.08 245.85,9.58 C 245.85,9.81 245.85,10.73 245.99,11.09 L 246.98,11.09 L 246.98,10.94 C 246.72,10.79 246.66,10.68 246.65,10.34 L 246.6,9.25 C 246.57,8.42 246.23,8.25 245.89,8.12 C 246.27,7.89 246.74,7.59 246.74,6.7 C 246.74,5.43 245.71,5.1 244.76,5.1 L 242.02,5.1 z M 242.83,5.76 L 244.81,5.76 C 245.23,5.76 245.89,5.88 245.89,6.79 C 245.89,7.68 245.28,7.83 244.67,7.83 L 242.83,7.83 L 242.83,5.76 z"
            style={{ fill: "#888689", fillOpacity: 1, fillRule: "nonzero", stroke: "none" }}
          />
        </svg>
      );

      // --- from components/MissionButton.tsx ---
      const MissionButton = ({ label, onClick, isLoading, disabled }) => {
        const isDisabled = isLoading || disabled;

        return (
          <button
            onClick={onClick}
            disabled={isDisabled}
            className={`
              w-full flex items-center justify-center text-center px-6 py-5 
              text-lg font-bold text-white rounded-xl shadow-lg 
              transition-all duration-200 ease-in-out transform 
              focus:outline-none focus:ring-4 focus:ring-legrand-red focus:ring-opacity-50
              ${isDisabled
                ? 'bg-slate-400 cursor-not-allowed'
                : 'bg-legrand-red hover:bg-red-700 active:scale-95'
              }
            `}
          >
            {isLoading ? (
              <div className="flex items-center">
                <LoadingSpinnerIcon className="w-6 h-6 mr-3" />
                <span>Sending...</span>
              </div>
            ) : (
              label
            )}
          </button>
        );
      };

      // --- from components/ProfileSwitcher.tsx ---
      const ProfileSwitcher = ({ currentProfile, onProfileChange }) => {
        const baseClasses = "w-1/2 py-3 text-sm font-bold rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-legrand-red";
        const activeClasses = "bg-legrand-red text-white shadow-md";
        const inactiveClasses = "bg-white text-legrand-dark hover:bg-slate-50";

        return (
          <div className="w-full max-w-sm mx-auto flex p-1 bg-slate-200 rounded-xl space-x-1">
            <button
              onClick={() => onProfileChange('profile1')}
              className={`${baseClasses} ${currentProfile === 'profile1' ? activeClasses : inactiveClasses}`}
            >
              ES
            </button>
            <button
              onClick={() => onProfileChange('profile2')}
              className={`${baseClasses} ${currentProfile === 'profile2' ? activeClasses : inactiveClasses}`}
            >
              Packing Line
            </button>
          </div>
        );
      };

      // --- from components/StatusDisplay.tsx ---
      const StatusDisplay = ({ status, message }) => {
        if (status === 'idle' || !message) {
          return <div className="h-14"></div>; // Reserve space
        }

        const baseClasses = 'flex items-center justify-center p-4 rounded-lg text-sm font-medium transition-opacity duration-300';
        let specificClasses = '';
        let IconComponent = null;

        switch (status) {
          case 'loading':
            specificClasses = 'bg-blue-100 text-blue-800';
            IconComponent = LoadingSpinnerIcon;
            break;
          case 'success':
            specificClasses = 'bg-green-100 text-green-800';
            IconComponent = CheckCircleIcon;
            break;
          case 'error':
            specificClasses = 'bg-red-100 text-red-800';
            IconComponent = XCircleIcon;
            break;
        }

        return (
          <div className={`h-14 w-full ${baseClasses} ${specificClasses}`}>
            {IconComponent && <IconComponent className="w-5 h-5 mr-3 flex-shrink-0" />}
            <span className="text-center">{message}</span>
          </div>
        );
      };

      // --- from App.tsx ---
      const App = () => {
        const [currentProfile, setCurrentProfile] = useState('profile1');
        const [missions, setMissions] = useState(PROFILE_1_MISSIONS);
        const [status, setStatus] = useState({ type: 'idle', message: '' });
        const [loadingMission, setLoadingMission] = useState(null);
        
        const [ipAddress, setIpAddress] = useState(() => localStorage.getItem('kukaIpAddress') || '192.168.1.100');
        const [port, setPort] = useState(() => localStorage.getItem('kukaPort') || '8081');
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);

        useEffect(() => {
          localStorage.setItem('kukaIpAddress', ipAddress);
        }, [ipAddress]);
        
        useEffect(() => {
          localStorage.setItem('kukaPort', port);
        }, [port]);

        useEffect(() => {
          setMissions(currentProfile === 'profile1' ? PROFILE_1_MISSIONS : PROFILE_2_MISSIONS);
        }, [currentProfile]);

        const handleSubmitMission = useCallback(async (mission) => {
          if (!ipAddress || !port) {
            setStatus({ type: 'error', message: 'Please set the system IP address and Port.' });
            setIsSettingsOpen(true);
            setTimeout(() => setStatus({ type: 'idle', message: '' }), 5000);
            return;
          }
          
          const missionCode = mission.templateCode;
          const timestamp = Date.now();
          const missionPayload = {
              orgId: "UNIVERSAL",
              requestId: `req-${missionCode}-${timestamp}`,
              missionCode: `mission-${missionCode}-${timestamp}`,
              missionType: "MOVE",
              robotType: "LIFT",
              templateCode: missionCode,
              priority: 1,
              lockRobotAfterFinish: false,
          };

          console.log('Dispatching Mission:', JSON.stringify(missionPayload, null, 2));
          setStatus({ type: 'loading', message: `Dispatching '${mission.label}'...` });
          setLoadingMission(mission.label);

          const apiUrl = `http://${ipAddress}:${port}/interfaces/api/amr/submitMission`;

          try {
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(missionPayload),
            });

            const responseData = await response.json();

            if (!response.ok || !responseData.success) {
              const apiMessage = responseData.message || `API Error Code: ${responseData.code || 'N/A'}`;
              throw new Error(apiMessage);
            }
            
            console.log('Success Response:', responseData);
            setStatus({ type: 'success', message: `Mission '${mission.label}' dispatched successfully!` });

          } catch (error) {
            console.error('Failed to dispatch mission:', error);
            let errorMessage = 'An unknown error occurred.';
            if (error instanceof TypeError) {
              errorMessage = `Network error. Could not connect to ${ipAddress}:${port}. Check IP/Port and network connection.`;
            } else if (error instanceof Error) {
              errorMessage = error.message;
            }
            setStatus({ type: 'error', message: `Failed: ${errorMessage}` });
          } finally {
              setLoadingMission(null);
              setTimeout(() => setStatus({ type: 'idle', message: '' }), 5000);
          }
        }, [ipAddress, port]);

        return (
          <div className="min-h-screen bg-slate-100 flex flex-col items-center p-4 sm:p-6 lg:p-8">
            <div className="w-full max-w-md mx-auto">
              <header className="flex justify-center items-center mb-6">
                  <LegrandLogo className="w-48 h-auto" />
              </header>

              <main className="bg-white p-6 rounded-2xl shadow-md">
                  <div className="flex justify-end">
                      <button
                          onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                          className="text-slate-400 hover:text-legrand-red transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-legrand-red rounded-full p-1"
                          aria-label={isSettingsOpen ? 'Close connection settings' : 'Open connection settings'}
                          aria-expanded={isSettingsOpen}
                      >
                          <GearIcon className="w-6 h-6" />
                      </button>
                  </div>
                  
                  <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isSettingsOpen ? 'max-h-48 pt-2' : 'max-h-0'}`}>
                    <div className="pb-6 border-b border-slate-200">
                        <h2 className="text-sm font-bold text-slate-600 mb-2">System Connection</h2>
                        <div className="flex flex-col sm:flex-row gap-2">
                            <div className="flex-grow">
                                <label htmlFor="ipAddress" className="sr-only">IP Address</label>
                                <input
                                    type="text"
                                    id="ipAddress"
                                    value={ipAddress}
                                    onChange={(e) => setIpAddress(e.target.value.trim())}
                                    placeholder="192.168.1.100"
                                    className="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-legrand-red focus:border-legrand-red"
                                    aria-label="System IP Address"
                                />
                            </div>
                            <div>
                                <label htmlFor="port" className="sr-only">Port</label>
                                <input
                                    type="number"
                                    id="port"
                                    value={port}
                                    onChange={(e) => setPort(e.target.value)}
                                    placeholder="80"
                                    className="w-full sm:w-24 px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-legrand-red focus:border-legrand-red"
                                    aria-label="System Port"
                                />
                            </div>
                        </div>
                        {!ipAddress && <p className="text-xs text-red-500 mt-2">IP Address is required to send missions.</p>}
                    </div>
                  </div>

                  <div className="mt-6">
                      <ProfileSwitcher currentProfile={currentProfile} onProfileChange={setCurrentProfile} />
                  </div>
                  
                  <div className="my-6">
                      <StatusDisplay status={status.type} message={status.message} />
                  </div>

                  <div className="space-y-4">
                    {missions.map((mission) => (
                      <MissionButton
                        key={mission.label}
                        label={mission.label}
                        onClick={() => handleSubmitMission(mission)}
                        isLoading={loadingMission === mission.label}
                        disabled={!ipAddress || (loadingMission !== null && loadingMission !== mission.label)}
                      />
                    ))}
                  </div>
              </main>
              <footer className="text-center mt-6 text-xs text-slate-500">
                  <p>AMR Mission Control Demo Interface</p>
                  <p>Click the gear icon to configure your system's IP and Port.</p>
                  <p> Created by: Daniel Nilsson </p>
              </footer>
            </div>
          </div>
        );
      };

      // --- from index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
    
    <!-- Service Worker for Offline Capability -->
    <script>
        if ('serviceWorker' in navigator) {
            // We need to register the service worker from a real file, not a blob URL, for PWA installability.
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>


